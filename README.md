# DXF Diff Manager - DXF差分管理ツール

## 概要

このツールは、流用図面（新）と流用元図面（旧）を自動的にペアリングし、差分をDXFフォーマットで出力するStreamlitアプリケーションです。

複数のDXFファイルから図面番号と流用元図番を自動抽出し、ペアごとに差分を可視化します。さらに、親子関係マスター管理機能により、図面間の流用関係を自動的に記録・管理できます。

## 主な機能

### 1. 親子関係マスター管理
- Parent-Child_list.xlsx を使った親子関係の自動管理
- ファイルをアップロードすると自動的に読み込まれる（ボタン不要）
- 新しく見つかった親子関係を自動的にマスターに追加
- 既存レコードは上書き更新（Relation, Title, Subtitle, Recorded Date, エンティティ数）
- **Child**: 図番（新）
- **Parent**: 流用元図番（旧）
- **Relation**: 関係種別（RevUp / 流用）
- **Title**: 図面タイトル
- **Subtitle**: 図面サブタイトル
- **Recorded Date**: 実行日時を自動記入
- **エンティティ数**: 差分比較結果の定量データ（5項目）
  - Deleted Entities: 削除された図形数
  - Added Entities: 追加された図形数
  - Diff Entities: 差分図形数（削除+追加）
  - Unchanged Entities: 変更なし図形数
  - Total Entities: 総図形数
- 更新されたマスターをZIPに含めてダウンロード

### 2. 自動ペアリング機能
- DXFファイルから図面番号（図番）、流用元図番、タイトル、サブタイトルを自動抽出
- 以下の優先順位でペアを自動作成：
  1. **RevUpペア**: Revision識別子（末尾1文字）のみ異なる同一図面
  2. **流用ペア**: 図番と流用元図番の関係
- 図番が抽出できない場合はファイル名を使用

#### RevUpペアの仕組み
- 図番の最後の1文字（Revision識別子）のみが異なる図面を自動検出
- 例: `DE5313-008-02A`, `DE5313-008-02B`, `DE5313-008-02C`, `DE5313-008-02D`
- アルファベット順に2つずつペアを作成
  - A, B, C, D → ペア: A-B, C-D
  - A, D, E, G → ペア: A-D, E-G
- RevUpペアは流用ペアより優先される
- 親子関係台帳の「Relation」列に「RevUp」と記録される

### 3. ペアリスト管理
- 完全なペア（流用元図面が揃っている）を表示
  - 図番（新）、流用元図番（旧）、関係種別（RevUp/流用）、ステータスを表示
- 流用元図面が不足しているペアを警告表示
- 流用元図番が指定されていない図面を情報表示

### 4. 追加アップロード機能
- 不足している流用元図面を後から追加可能
- ペアリストが自動的に更新される

### 5. 差分比較処理とエンティティ数計測
- 完全なペアのみを自動的に処理
- 図番（新）を基準A、流用元図番（旧）を比較対象Bとして比較
- DXF Visual Diffの高精度な比較エンジンを使用
- **エンティティ数の自動計測**（新機能）
  - 各ペアについて削除・追加・変更なし・総図形数を自動計測
  - 差分の定量評価が可能
  - Web UIに3項目表示：削除図形数、追加図形数、総図形数
  - 親子関係台帳に5項目記録：上記3項目＋差分図形数、変更なし図形数

### 6. 一括ダウンロード
- 処理結果をZIPファイルで一括ダウンロード
- ファイル名: `{図番}_vs_{流用元図番}.dxf`
- 更新された親子関係マスター（エンティティ数を含む）も含まれる（アップロードした場合）

## 使用方法

1. **ステップ0: 親子関係マスターのアップロード（オプション）**
   - 親子管理台帳をアップロード（または、ドラッグ＆ドロップ）
   - ファイルがアップロードされると自動的に読み込まれる
   - 新しく見つかった親子関係が自動的にマスターに追加される
   - 既存のペアは最新情報で更新される（Relation, Title, Subtitle, Recorded Date, エンティティ数）
   - このステップをスキップするとマスター管理は実行しない

2. **ステップ1: DXFファイルのアップロード**
   - 複数のDXFファイルを一括選択
   - 自動的に図番、流用元図番、タイトル、サブタイトルが抽出される
   - RevUpペアが優先的に作成され、次に流用ペアが作成される
   - ペアリストに「関係」列が表示され、RevUp/流用が識別される
   - マスターが読み込まれている場合、完全なペアが自動的に追加される

3. **ステップ2: 追加アップロード（オプション）**
   - 流用元図面が不足している場合、警告が表示される
   - 「追加アップロード」で不足している図面を追加
   - 図番ペアリストが自動的に更新される
   - マスターが読み込まれている場合、新しい完全なペアが追加される

4. **ステップ3: 差分比較**
   - オプション設定（座標許容誤差、レイヤー色）を調整（任意）
   - 「差分比較を開始」ボタンをクリック
   - 完全なペアのみが処理される
   - 各ペアのエンティティ数が自動計測される
   - 処理結果に削除図形数、追加図形数、総図形数が表示される
   - 処理完了後、ZIPファイルをダウンロード
   - ZIPには差分DXFファイルと更新されたマスター（エンティティ数を含む）が含まれる

## 出力ファイルの内容

生成されたDXFファイルには、以下の3つのレイヤーで差分が表示されます：

- **ADDED（デフォルト色: シアン）**: 新図面にのみ存在する要素（追加された要素）
- **DELETED（デフォルト色: マゼンタ）**: 旧図面にのみ存在する要素（削除された要素）
- **UNCHANGED（デフォルト色: 白/黒）**: 両方の図面に存在し変更がない要素

## 図面番号・タイトルの抽出ルール

### 図番の判定
1. **ラベルベース検出**（優先）
   - 「DWG No.」ラベルから80単位以内の図面番号を検出
   - 「流用元図番」ラベルから80単位以内の図面番号を検出
   - ファイル名との一致も考慮

2. **座標ベース検出**（フォールバック）
   - 複数図面が1ファイルにある場合、最も右側の図面のみを対象
   - 最も右下にある図面番号を「図番（新）」とする
   - 2番目に座標値が大きい図面番号を「流用元図番（旧）」とする

### タイトル・サブタイトルの抽出
- 「TITLE」ラベルから横方向80単位以内のテキストを抽出
- タイトル: TITLEラベルと同じ高さ
- サブタイトル: タイトルの下の行

### 図面番号のパターン
- 標準パターン: `[A-Z]{2}\d{4}-\d{3}-\d{2}[A-Z]`
- 例: `DE5313-008-02B`
- Revision識別子: 末尾1文字（例: B）

### 図番が見つからない場合
- ファイル名（拡張子なし）を図番として使用

## オプション設定

### 座標許容誤差
- デフォルト: 0.01
- 微小な座標のずれを許容する誤差値

### レイヤー色設定
- **削除エンティティの色**: 旧図面にのみ存在する要素（デフォルト: マゼンタ）
- **追加エンティティの色**: 新図面にのみ存在する要素（デフォルト: シアン）
- **変更なしエンティティの色**: 両方に存在する要素（デフォルト: 白/黒）

## 技術仕様

### 使用技術
- **Streamlit**: Webインターフェース
- **ezdxf**: DXFファイルの読み込みと書き込み
- **pandas**: データ処理とExcel操作
- **numpy**: 座標変換

### 依存モジュール
- `config.py`: 設定値の一元管理（UI、差分、抽出、ヘルプテキスト）
- `utils/extract_labels.py`: 図面番号・タイトル抽出
- `utils/compare_dxf.py`: DXF差分比較（エンティティ数計測機能付き）
- `utils/common_utils.py`: 共通ユーティリティ

### アーキテクチャ
- セッション状態による状態管理
- モジュラー設計（機能別関数分割）
- 一時ファイルによる安全なファイル処理
- ZIP圧縮による一括ダウンロード
- 設定の外部化（config.py）による保守性向上

## 注意事項

1. **図番の精度**
   - 図面番号が標準パターンに従っていない場合、正しく抽出できない可能性があります
   - その場合はファイル名が使用されます

2. **RevUpペアの優先**
   - RevUpペア（Revision違いの図面）は流用ペアより優先されます
   - 同一図面がRevUpペアと流用ペアの両方に該当する場合、RevUpペアとして処理されます

3. **流用元図番**
   - 流用元図番が図面内に記載されていない場合、そのペアは比較対象外となります
   - ただし、RevUpペアは流用元図番の記載がなくても自動検出されます

4. **エンティティ数**
   - エンティティ数は差分比較完了後に親子関係台帳に記録されます
   - 比較に失敗したペアにはエンティティ数は記録されません

5. **ファイルサイズ**
   - 大量のDXFファイル（数十〜数百ファイル）を一度に処理する場合、メモリ消費に注意してください

6. **一時ファイル**
   - 処理中は一時ファイルが作成されます
   - 処理完了後、またはアプリ再起動時にクリーンアップされます
