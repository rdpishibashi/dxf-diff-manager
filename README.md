# DXF Diff Manager - DXF差分管理ツール

## 概要

このツールは、流用図面（新）と流用元図面（旧）を自動的にペアリングし、差分をDXFフォーマットで出力するStreamlitアプリケーションです。

複数のDXFファイルから図面番号と流用元図番を自動抽出し、ペアごとに差分を可視化します。さらに、親子関係マスター管理機能により、図面間の流用関係を自動的に記録・管理できます。

## 主な機能

### 1. 親子関係マスター管理（新機能）
- Parent-Child_list.xlsx を使った親子関係の自動管理
- ファイルをアップロードすると自動的に読み込まれる（ボタン不要）
- 新しく見つかった親子関係を自動的にマスターに追加
- 重複する関係はスキップ（既存レコードを保護）
- **Parent**: 流用元図番（旧）
- **Child**: 図番（新）
- **Date**: 実行日時を自動記入
- **Function カラムには何も書き込まれません**（既存の値は保持）
- 更新されたマスターをZIPに含めてダウンロード

### 2. 自動ペアリング機能
- DXFファイルから図面番号（図番）と流用元図番を自動抽出
- 図番と流用元図番のペアを自動作成
- 図番が抽出できない場合はファイル名を使用

### 3. ペアリスト管理
- 完全なペア（流用元図面が揃っている）を表示
- 流用元図面が不足しているペアを警告表示
- 流用元図番が指定されていない図面を情報表示

### 4. 追加アップロード機能
- 不足している流用元図面を後から追加可能
- ペアリストが自動的に更新される

### 5. 差分比較処理
- 完全なペアのみを自動的に処理
- 図番（新）を基準A、流用元図番（旧）を比較対象Bとして比較
- DXF Visual Diffの高精度な比較エンジンを使用

### 6. 一括ダウンロード
- 処理結果をZIPファイルで一括ダウンロード
- ファイル名: `{図番}_vs_{流用元図番}.dxf`
- 更新された親子関係マスターも含まれる（アップロードした場合）

## 使用方法

1. **ステップ0: 親子関係マスターのアップロード（オプション）**
   - 親子管理台帳をアップロード（または、ドラッグ＆ドロップ）
   - ファイルがアップロードされると自動的に読み込まれる
   - 新しく見つかった親子関係が自動的にマスターに追加される
   - Date カラムには実行日時が自動記入される
   - Function カラムには何も書き込まれない（既存の値は保持）
   - このステップをスキップするとマスター管理は実行しない

2. **ステップ1: DXFファイルのアップロード**
   - 複数のDXFファイルを一括選択
   - 「図番を抽出」ボタンをクリック
   - 自動的に図番と流用元図番が抽出され、図番ペアリストが表示される
   - マスターが読み込まれている場合、完全なペアが自動的に追加される

3. **ステップ2: 追加アップロード（オプション）**
   - 流用元図面が不足している場合、警告が表示される
   - 「追加アップロード」で不足している図面を追加
   - 図番ペアリストが自動的に更新される
   - マスターが読み込まれている場合、新しい完全なペアが追加される

4. **ステップ3: 差分比較**
   - オプション設定（座標許容誤差、レイヤー色）を調整（任意）
   - 「差分比較を開始」ボタンをクリック
   - 完全なペアのみが処理される
   - 処理完了後、ZIPファイルをダウンロード
   - ZIPには差分DXFファイルと更新されたマスター（アップロードした場合）が含まれる

## 出力ファイルの内容

生成されたDXFファイルには、以下の3つのレイヤーで差分が表示されます：

- **ADDED（デフォルト色: シアン）**: 新図面にのみ存在する要素（追加された要素）
- **DELETED（デフォルト色: マゼンタ）**: 旧図面にのみ存在する要素（削除された要素）
- **UNCHANGED（デフォルト色: 白/黒）**: 両方の図面に存在し変更がない要素

## 図面番号の抽出ルール

### 図番の判定
- 図面内の座標に基づいて自動判定
- 最も右下にある図面番号を「図番（新）」とする
- 2番目に座標値が大きい図面番号を「流用元図番（旧）」とする

### 図面番号のパターン
- 標準パターン: `[A-Z]{2}\d{4}-\d{3}-\d{2}[A-Z]`
- 例: `DE5313-008-02B`

### 図番が見つからない場合
- ファイル名（拡張子なし）を図番として使用

## オプション設定

### 座標許容誤差
- デフォルト: 0.01
- 微小な座標のずれを許容する誤差値

### レイヤー色設定
- **削除エンティティの色**: 旧図面にのみ存在する要素（デフォルト: マゼンタ）
- **追加エンティティの色**: 新図面にのみ存在する要素（デフォルト: シアン）
- **変更なしエンティティの色**: 両方に存在する要素（デフォルト: 白/黒）

## 技術仕様

### 使用技術
- **Streamlit**: Webインターフェース
- **ezdxf**: DXFファイルの読み込みと書き込み
- **pandas**: データ処理
- **numpy**: 座標変換

### 依存モジュール
- `utils/extract_labels.py`: 図面番号抽出（DXF-extract-labelsから）
- `utils/compare_dxf.py`: DXF差分比較（DXF-visual-diffから）
- `utils/common_utils.py`: 共通ユーティリティ

### アーキテクチャ
- セッション状態による状態管理
- 一時ファイルによる安全なファイル処理
- ZIP圧縮による一括ダウンロード

## 注意事項

1. **図番の精度**
   - 図面番号が標準パターンに従っていない場合、正しく抽出できない可能性があります
   - その場合はファイル名が使用されます

2. **流用元図番**
   - 流用元図番が図面内に記載されていない場合、そのペアは比較対象外となります

3. **ファイルサイズ**
   - 大量のDXFファイル（数十〜数百ファイル）を一度に処理する場合、メモリ消費に注意してください

4. **一時ファイル**
   - 処理中は一時ファイルが作成されます
   - 処理完了後、またはアプリ再起動時にクリーンアップされます
